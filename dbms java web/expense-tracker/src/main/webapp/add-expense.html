<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Expense - ExpenseTracker</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <header>
        <div class="container">
            <div class="logo">ExpenseTracker <span>| Friend Groups</span></div>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">Dashboard</a></li>
                    <li><a href="create-group.html">Create Group</a></li>
                    <li><a href="add-member.html">Add Member</a></li>
                    <li><a href="transaction.html" class="active">Transactions</a></li>
                    <li><a href="settlement.html">Settlements</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <main>
            <div class="page-header">
                <h1 class="page-title">Add New Expense</h1>
            </div>

            <div id="alertBox" class="hidden"></div>

            <div class="card">
                <form id="expenseForm" onsubmit="submitExpense(event)">
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="groupId">Select Group *</label>
                            <select id="groupId" name="groupId" required onchange="loadGroupMembers()">
                                <option value="">Choose a group...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="paidBy">Paid By *</label>
                            <select id="paidBy" name="paidBy" required>
                                <option value="">Select who paid...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Description *</label>
                        <input type="text" id="description" name="description" placeholder="e.g., Dinner at restaurant"
                            required>
                    </div>

                    <div class="grid grid-2">
                        <div class="form-group">
                            <label for="amount">Amount (₹) *</label>
                            <input type="number" id="amount" name="amount" placeholder="0.00" step="0.01" min="0.01"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="splitType">Split Type *</label>
                            <select id="splitType" name="splitType" onchange="toggleCustomSplit()">
                                <option value="EQUAL">Equal Split</option>
                                <option value="CUSTOM">Custom Split</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Participants *</label>
                        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 10px;">
                            Select members who participated in this expense
                        </p>
                        <div id="participantsContainer" class="checkbox-group">
                            <p style="color: var(--text-secondary);">Select a group first</p>
                        </div>
                    </div>

                    <div id="customSplitContainer" class="hidden">
                        <div class="form-group">
                            <label>Custom Amounts</label>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 10px;">
                                Enter specific amount for each participant
                            </p>
                            <div id="customAmountsContainer"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Add Expense</button>
                        <a href="index.html" class="btn btn-outline">Cancel</a>
                    </div>
                </form>
            </div>

            <!-- Preview Card -->
            <div class="card" id="previewCard" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">Split Preview</h3>
                </div>
                <div id="splitPreview"></div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = '/api';
        let groupMembers = [];

        document.addEventListener('DOMContentLoaded', function () {
            loadGroups();
        });

        async function loadGroups() {
            try {
                const response = await fetch(`${API_BASE}/group`);
                const groups = await response.json();

                const select = document.getElementById('groupId');
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.groupId;
                    option.textContent = group.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        async function loadGroupMembers() {
            const groupId = document.getElementById('groupId').value;
            if (!groupId) return;

            try {
                const response = await fetch(`${API_BASE}/group/${groupId}/members`);
                groupMembers = await response.json();

                // Update paid by dropdown
                const paidBySelect = document.getElementById('paidBy');
                paidBySelect.innerHTML = '<option value="">Select who paid...</option>';
                groupMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.phoneNumber;
                    option.textContent = member.name;
                    paidBySelect.appendChild(option);
                });

                // Update participants checkboxes
                const container = document.getElementById('participantsContainer');
                container.innerHTML = groupMembers.map(member => `
                    <label class="checkbox-item">
                        <input type="checkbox" name="participants" value="${member.phoneNumber}" 
                               onchange="updatePreview()" checked>
                        <span>${member.name}</span>
                    </label>
                `).join('');

                updatePreview();
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }

        function toggleCustomSplit() {
            const splitType = document.getElementById('splitType').value;
            const customContainer = document.getElementById('customSplitContainer');

            if (splitType === 'CUSTOM') {
                customContainer.classList.remove('hidden');
                updateCustomAmounts();
            } else {
                customContainer.classList.add('hidden');
            }
            updatePreview();
        }

        function updateCustomAmounts() {
            const selectedParticipants = getSelectedParticipants();
            const container = document.getElementById('customAmountsContainer');

            container.innerHTML = selectedParticipants.map(userId => {
                const member = groupMembers.find(m => m.phoneNumber == userId);
                return `
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="min-width: 150px; margin: 0;">${member.name}:</label>
                        <input type="number" name="customAmount_${userId}" 
                               placeholder="0.00" step="0.01" style="flex: 1;"
                               onchange="updatePreview()">
                    </div>
                `;
            }).join('');
        }

        function getSelectedParticipants() {
            const checkboxes = document.querySelectorAll('input[name="participants"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function updatePreview() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const splitType = document.getElementById('splitType').value;
            const participants = getSelectedParticipants();

            if (participants.length === 0 || amount === 0) {
                document.getElementById('previewCard').style.display = 'none';
                return;
            }

            document.getElementById('previewCard').style.display = 'block';
            const previewDiv = document.getElementById('splitPreview');

            if (splitType === 'EQUAL') {
                const share = (amount / participants.length).toFixed(2);
                previewDiv.innerHTML = participants.map(userId => {
                    const member = groupMembers.find(m => m.phoneNumber == userId);
                    return `
                        <div class="settlement-item">
                            <div class="member-chip">
                                <div class="member-avatar">${member.name.charAt(0)}</div>
                                <span>${member.name}</span>
                            </div>
                            <span>₹${share}</span>
                        </div>
                    `;
                }).join('');
            } else {
                // Custom split preview
                let previewHtml = '';
                let total = 0;
                participants.forEach(userId => {
                    const member = groupMembers.find(m => m.phoneNumber == userId);
                    const input = document.querySelector(`input[name="customAmount_${userId}"]`);
                    const customAmount = input ? parseFloat(input.value) || 0 : 0;
                    total += customAmount;
                    previewHtml += `
                        <div class="settlement-item">
                            <div class="member-chip">
                                <div class="member-avatar">${member.name.charAt(0)}</div>
                                <span>${member.name}</span>
                            </div>
                            <span>₹${customAmount.toFixed(2)}</span>
                        </div>
                    `;
                });

                const diff = amount - total;
                if (Math.abs(diff) > 0.01) {
                    previewHtml += `
                        <div class="alert ${diff > 0 ? 'alert-error' : 'alert-info'}">
                            ${diff > 0 ? 'Remaining: ₹' + diff.toFixed(2) : 'Over by: ₹' + Math.abs(diff).toFixed(2)}
                        </div>
                    `;
                }
                previewDiv.innerHTML = previewHtml;
            }
        }

        async function submitExpense(event) {
            event.preventDefault();

            const formData = new FormData();
            formData.append('groupId', document.getElementById('groupId').value);
            formData.append('paidBy', document.getElementById('paidBy').value);
            formData.append('amount', document.getElementById('amount').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('splitType', document.getElementById('splitType').value);

            const participants = getSelectedParticipants();
            participants.forEach(p => formData.append('participants', p));

            if (document.getElementById('splitType').value === 'CUSTOM') {
                participants.forEach(userId => {
                    const input = document.querySelector(`input[name="customAmount_${userId}"]`);
                    formData.append('customAmounts', input ? input.value : '0');
                });
            }

            try {
                const response = await fetch(`${API_BASE}/expense`, {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('Expense added successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } else {
                    showAlert('Error: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('Error adding expense: ' + error.message, 'error');
            }
        }

        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.className = `alert alert-${type}`;
            alertBox.textContent = message;
            alertBox.classList.remove('hidden');
        }

        // Update preview when amount changes
        document.getElementById('amount').addEventListener('input', updatePreview);
    </script>
</body>

</html>