<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExpenseTracker - Friend Group Expense Management</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <header>
        <div class="container">
            <div class="logo">ExpenseTracker <span>| Friend Groups</span></div>
            <nav>
                <ul>
                    <li><a href="index.html" class="active">Dashboard</a></li>
                    <li><a href="create-group.html">Create Group</a></li>
                    <li><a href="add-expense.html">Expenses &amp; Payments</a></li>
                    <li><a href="settlement.html">Settlements</a></li>
                </ul>
            </nav>
            <div class="global-group-shell">
                <select id="globalGroupSelect" class="group-select"></select>
                <button id="deleteGroupBtn" class="btn btn-outline btn-danger-ghost" type="button">
                    Delete Group
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                <div class="page-header-actions">
                    <a href="create-group.html" class="btn btn-primary">New Group</a>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalExpenses">â‚¹0</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="totalMembers">0</div>
                    <div class="stat-label">Members</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="pendingAmount">â‚¹0</div>
                    <div class="stat-label">Pending Settlements</div>
                </div>
            </div>

            <!-- Grid Layout -->
            <div class="grid grid-2">
                <!-- Group Members -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Group Members</h3>
                    </div>
                    <div id="membersList" class="member-list">
                        <div class="empty-state">
                            <p>Select a group to view members</p>
                        </div>
                    </div>
                </div>

                <!-- Balance Summary -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Balance Summary</h3>
                    </div>
                    <div id="balancesList">
                        <div class="empty-state">
                            <p>Select a group to view balances</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Expenses -->
            <div class="card mt-20">
                <div class="card-header">
                    <h3 class="card-title">Recent Expenses</h3>
                    <a href="add-expense.html" class="btn btn-primary">+ Add Expense</a>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Paid By</th>
                            <th>Split Type</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="expensesList">
                        <tr>
                            <td colspan="5" class="text-center">Select a group to view expenses</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Who Owes Whom -->
            <div class="card mt-20">
                <div class="card-header">
                    <h3 class="card-title">Who Owes Whom</h3>
                    <a href="settlement.html" class="btn btn-outline">View All</a>
                </div>
                <div id="settlementsList">
                    <div class="empty-state">
                        <p>Select a group to view settlements</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Lightweight global state helpers (duplicated across pages for now)
        const ET = (() => {
            const API_BASE = '/api';
            const KEY = 'expenseTracker.selectedGroupId';

            function getStoredGroupId() {
                try {
                    return window.localStorage.getItem(KEY) || '';
                } catch (e) {
                    return '';
                }
            }

            function setStoredGroupId(id) {
                try {
                    if (id && String(id).length > 0) {
                        window.localStorage.setItem(KEY, String(id));
                    } else {
                        window.localStorage.removeItem(KEY);
                    }
                } catch (e) { }
            }

            return { API_BASE, getStoredGroupId, setStoredGroupId };
        })();

        document.addEventListener('DOMContentLoaded', function () {
            initGlobalGroupSelector();
        });

        async function initGlobalGroupSelector() {
            const select = document.getElementById('globalGroupSelect');
            const deleteBtn = document.getElementById('deleteGroupBtn');

            try {
                const response = await fetch(`${ET.API_BASE}/group`);
                const groups = await response.json();
                const storedId = ET.getStoredGroupId();

                select.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = groups.length ? 'Select group' : 'No groups yet';
                select.appendChild(placeholder);

                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.groupId;
                    option.textContent = group.name;
                    select.appendChild(option);
                });

                if (storedId && groups.some(g => String(g.groupId) === storedId)) {
                    select.value = storedId;
                    loadGroupData(storedId);
                }

                select.addEventListener('change', () => {
                    const groupId = select.value;
                    ET.setStoredGroupId(groupId);
                    if (groupId) {
                        loadGroupData(groupId);
                    }
                });

                deleteBtn.addEventListener('click', () => handleDeleteGroup(select, groups));
            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        async function handleDeleteGroup(selectEl, groupsCache) {
            const currentId = selectEl.value || ET.getStoredGroupId();
            if (!currentId) {
                alert('Select a group to delete.');
                return;
            }
            const currentName = selectEl.options[selectEl.selectedIndex]?.text || 'this group';
            const confirmed = window.confirm(`Delete "${currentName}"? This will remove all its expenses and settlements.`);
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/group/${currentId}`, { method: 'DELETE' });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    alert('Unable to delete group: ' + (err.error || response.statusText));
                    return;
                }

                // Refresh list
                const refreshed = await fetch('/api/group').then(r => r.json());
                selectEl.innerHTML = '';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = refreshed.length ? 'Select group' : 'No groups yet';
                selectEl.appendChild(placeholder);

                let nextId = '';
                refreshed.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g.groupId;
                    opt.textContent = g.name;
                    selectEl.appendChild(opt);
                });

                if (refreshed.length > 0) {
                    nextId = String(refreshed[0].groupId);
                    selectEl.value = nextId;
                    ET.setStoredGroupId(nextId);
                    loadGroupData(nextId);
                } else {
                    ET.setStoredGroupId('');
                    clearDashboard();
                }
            } catch (e) {
                alert('Error deleting group: ' + e.message);
            }
        }

        function clearDashboard() {
            document.getElementById('totalExpenses').textContent = 'â‚¹0';
            document.getElementById('totalMembers').textContent = '0';
            document.getElementById('pendingAmount').textContent = 'â‚¹0';
            document.getElementById('membersList').innerHTML = '<div class="empty-state"><p>Create or select a group to view members</p></div>';
            document.getElementById('balancesList').innerHTML = '<div class="empty-state"><p>Create or select a group to view balances</p></div>';
            document.getElementById('expensesList').innerHTML = '<tr><td colspan="5" class="text-center">Create or select a group to view expenses</td></tr>';
            document.getElementById('settlementsList').innerHTML = '<div class="empty-state"><p>Create or select a group to view settlements</p></div>';
        }

        // Load group data whenever the global selection changes
        async function loadGroupData(groupId) {
            if (!groupId) return;

            loadMembers(groupId);
            loadExpenses(groupId);
            loadBalances(groupId);
            loadSettlements(groupId);
        }

        // Load members
        async function loadMembers(groupId) {
            try {
                const response = await fetch(`${ET.API_BASE}/group/${groupId}/members`);
                const members = await response.json();

                document.getElementById('totalMembers').textContent = members.length;

                const membersList = document.getElementById('membersList');
                membersList.innerHTML = members.map(member => `
                    <div class="member-chip">
                        <div class="member-avatar">${member.name.charAt(0)}</div>
                        <span>${member.name}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }

        // Load expenses
        async function loadExpenses(groupId) {
            try {
                const response = await fetch(`${ET.API_BASE}/expense?groupId=${groupId}`);
                const expenses = await response.json();

                // Calculate total
                const total = expenses.reduce((sum, e) => sum + parseFloat(e.expense.amount), 0);
                document.getElementById('totalExpenses').textContent = 'â‚¹' + total.toFixed(2);

                const tbody = document.getElementById('expensesList');
                if (expenses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No expenses yet</td></tr>';
                    return;
                }

                tbody.innerHTML = expenses.slice(0, 5).map(e => `
                    <tr>
                        <td>${e.expense.description}</td>
                        <td><strong>â‚¹${parseFloat(e.expense.amount).toFixed(2)}</strong></td>
                        <td>${e.paidByName}</td>
                        <td><span class="badge badge-pending">${e.expense.splitType}</span></td>
                        <td>${new Date(e.expense.createdAt).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        // Load balances
        async function loadBalances(groupId) {
            try {
                const response = await fetch(`${ET.API_BASE}/settlement/balances?groupId=${groupId}`);
                const balances = await response.json();

                const balancesList = document.getElementById('balancesList');
                if (balances.length === 0) {
                    balancesList.innerHTML = '<p class="empty-state">All settled up!</p>';
                    return;
                }

                balancesList.innerHTML = balances.map(b => {
                    const isPositive = parseFloat(b.netBalance) >= 0;
                    return `
                        <div class="settlement-item">
                            <div class="member-chip">
                                <div class="member-avatar">${b.userName.charAt(0)}</div>
                                <span>${b.userName}</span>
                            </div>
                            <span class="${isPositive ? 'balance-positive' : 'balance-negative'}">
                                ${isPositive ? '+' : ''}â‚¹${parseFloat(b.netBalance).toFixed(2)}
                            </span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading balances:', error);
            }
        }

        // Load settlements
        async function loadSettlements(groupId) {
            try {
                const response = await fetch(`${ET.API_BASE}/settlement/summary?groupId=${groupId}`);
                const settlements = await response.json();

                // Calculate pending amount
                const pending = settlements.reduce((sum, s) => sum + parseFloat(s.amount), 0);
                document.getElementById('pendingAmount').textContent = 'â‚¹' + pending.toFixed(2);

                const settlementsList = document.getElementById('settlementsList');
                if (settlements.length === 0) {
                    settlementsList.innerHTML = '<p class="empty-state">All settled up! ðŸŽ‰</p>';
                    return;
                }

                settlementsList.innerHTML = settlements.slice(0, 5).map(s => `
                    <div class="settlement-item">
                        <div class="settlement-users">
                            <div class="member-chip">
                                <div class="member-avatar">${s.fromUserName.charAt(0)}</div>
                                <span>${s.fromUserName}</span>
                            </div>
                            <span class="settlement-arrow">â†’ owes â†’</span>
                            <div class="member-chip">
                                <div class="member-avatar">${s.toUserName.charAt(0)}</div>
                                <span>${s.toUserName}</span>
                            </div>
                        </div>
                        <span class="settlement-amount">â‚¹${parseFloat(s.amount).toFixed(2)}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading settlements:', error);
            }
        }
    </script>
</body>

</html>